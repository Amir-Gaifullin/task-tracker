---
version: v1.0
name: Ruby on Rails CI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
execution_time_limit:
  minutes: 10
auto_cancel:
  running:
    when: true
fail_fast:
  stop:
    when: true
global_job_config:
  prologue:
    commands:
      - checkout
      - cache restore
blocks:
- name: Lint
  task:
    jobs:
    - name: Run quality
      commands:
      - bundle install
      - bundle exec rubocop --parallel
      - cache store
- name: Test
  task:
    jobs:
    - name: Run tests
      commands:
      - sem-service start postgres
      - sem-service start redis
      - sem-version ruby 3.0.2
      - bundle install --local
      - yarn install --pure-lockfile
      - bundle exec rails db:setup
      - bundle exec rspec

---
version: v1.0
name: Ruby on Rails CI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
execution_time_limit:
  minutes: 10
auto_cancel:
  running:
    when: true
fail_fast:
  stop:
    when: true
global_job_config:
  env_vars:
    - name: BUNDLE_ARGS
      value: '--deployment --without development staging production --jobs 4'
  prologue:
    commands:
      - checkout
      - cache restore
blocks:
- name: Lint
  task:
    jobs:
    - name: Run quality
      commands:
      - bundle install ${BUNDLE_ARGS}
      - bundle exec rubocop  --parallel
- name: Test
  task:
    jobs:
    - name: Run tests
      commands:
      - sem-service start postgres
      - sem-service start redis
      - sem-version ruby 3.0.2
      - bundle install ${BUNDLE_ARGS} --local
      - yarn install --pure-lockfile
      - cache store
      - bundle exec rails db:setup
      - bundle exec rspec
